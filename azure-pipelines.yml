trigger:
  branches:
    include:
      - feature/*
      - main

pool: vinsontosh_agent_pool

parameters:
  - name: Code_Scanner
    type: boolean
    default: false

jobs:
- job: JobofBuild
  displayName: build chal raha hai
  steps:
  - task: TerraformInstaller@1
    displayName: 'install ho raha hai'
    inputs:
      terraformVersion: 'latest'
      
  - task: TerraformTask@5
    displayName: 'init chal raha hai'
    inputs:
      provider: azurerm
      command: 'init'
      backendServiceArm: 'vinsanserviceconnection'
      backendAzureRmStorageAccountName: 'vinsanstgacc'
      backendAzureRmContainerName: 'vinsancontainer'
      backendAzureRmKey: 'vinsan.terraform.tfstate'

  - task: TerraformTask@5
    displayName: 'validate chal raha hai '
    inputs:
      provider: azurerm
      command: 'validate'

  - task: TerraformTask@5
    displayName: 'fmt chal raha hai '
    inputs:
      provider: azurerm
      command: 'custom'
      outputTo: 'console'
      customCommand: 'fmt'
      environmentServiceNameAzureRM: 'vinsanserviceconnection'


  - task: TerraformTask@5
    displayName: 'plan chal raha hai '
    inputs:
      provider: azurerm
      command: 'plan'
      environmentServiceNameAzureRM: 'vinsanserviceconnection'
  
- job: Jobofscanning
  displayName: Job of scanning
  condition: eq(${{ parameters.Code_Scanner }}, true)
  steps:
  - task: tfsec@1
    inputs:
      version: 'v1.26.0'

- job: Jobofapply
  displayName: Job of apply
  dependsOn: JobofBuild
  condition: and(succeeded('JobofBuild'), eq(variables['Build.SourceBranchName'], 'main'))
  steps:
  - task: TerraformInstaller@1
    displayName: 'Terraform install ho raha hai'
    inputs:
      terraformVersion: 'latest'

  - task: TerraformTask@5
    displayName: 'Terraform init (apply ke liye)'
    inputs:
      provider: 'azurerm'
      command: 'init'
      backendServiceArm: 'vinsanserviceconnection'
      backendAzureRmStorageAccountName: 'vinsanstgacc'
      backendAzureRmContainerName: 'vinsancontainer'
      backendAzureRmKey: 'vinsan.terraform.tfstate'
    
  - task: TerraformTask@5
    displayName: 'Terraform apply chal raha hai'    
    inputs:
      provider: azurerm
      command: 'apply'
      environmentServiceNameAzureRM: 'vinsanserviceconnection'
      commandOptions: '-auto-approve'
      workingDirectory: '$(System.DefaultWorkingDirectory)'